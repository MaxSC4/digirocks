import{s as L,a as Se,c as Le,b as $e,d as pe,e as se,f as me,g as De}from"./index-B2erJZgl.js";function Ne(n,{width:o="100vw",height:e="100vh"}={}){n.innerHTML="";const r=document.createElement("div");r.classList.add("ts-viewer"),r.style.position="relative",r.style.overflow="hidden",r.style.width=o,r.style.height=e;const t=document.createElement("div");t.classList.add("ts-panzoom"),t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.transformOrigin="0 0",t.style.cursor="grab",t.style.willChange="transform";const s=document.createElement("div");s.classList.add("ts-annotation-layer"),s.style.position="absolute",s.style.top="0",s.style.left="0",s.style.width="100%",s.style.height="100%",s.style.pointerEvents="none",r.appendChild(t),n.appendChild(r);const l=document.createElement("img");l.classList.add("ts-image"),l.style.position="absolute",l.style.top="0",l.style.left="0",l.style.transformOrigin="0 0",l.style.userSelect="none",l.draggable=!1,l.style.willChange="transform",t.appendChild(l);const a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.classList.add("ts-zone-layer"),a.style.position="absolute",a.style.top="0",a.style.left="0",a.style.width="100%",a.style.height="100%",a.style.overflow="visible",a.style.pointerEvents="none",t.appendChild(a),t.appendChild(s);const i=document.createElement("div");return i.classList.add("ts-popup-layer"),i.style.position="absolute",i.style.top="0",i.style.left="0",i.style.width="100%",i.style.height="100%",i.style.pointerEvents="none",r.appendChild(i),{viewer:r,panZoomLayer:t,img:l,zoneSvg:a,annotationLayer:s,popupLayer:i}}function fe(n,o){const{scale:e,translate:r}=o;n.style.transform=`translate(${r.x}px, ${r.y}px) scale(${e})`}function ke(n,o,e,{minScale:r=.2,maxScale:t=5}={}){let s=!1,l={x:0,y:0};n.addEventListener("wheel",a=>{a.preventDefault();const i=-a.deltaY*.001,c=Math.min(Math.max(r,o.scale+i),t),m=n.getBoundingClientRect(),g=a.clientX-m.left,x=a.clientY-m.top;o.translate.x-=g*(c-o.scale)/o.scale,o.translate.y-=x*(c-o.scale)/o.scale,o.scale=c,e()}),n.addEventListener("mousedown",a=>{s=!0,l.x=a.clientX,l.y=a.clientY,n.style.cursor="grabbing"}),window.addEventListener("mouseup",()=>{s=!1,n.style.cursor="grab"}),window.addEventListener("mousemove",a=>{s&&(o.translate.x+=a.clientX-l.x,o.translate.y+=a.clientY-l.y,l.x=a.clientX,l.y=a.clientY,e())})}const Pe=[".png",".jpg",".jpeg",".tiff"];async function ve(n){try{const o=await fetch(n,{method:"HEAD"}),e=o.headers.get("Content-Type")||"";return o.ok&&e.startsWith("image/")}catch{return!1}}function T(n,o,e){const r=o.getBoundingClientRect(),t=n.clientX-r.left,s=n.clientY-r.top,l=(t-e.translate.x)/e.scale,a=(s-e.translate.y)/e.scale;return[l,a]}function Te(n,o,{size:e=100,zoomFactor:r=4}={}){const t=document.createElement("canvas");t.width=e,t.height=e,t.className="loupe2d",t.style.position="absolute",t.style.pointerEvents="none";let s;try{s=t.getContext("2d")}catch{s=null}let l=0;const a=16;function i(c){const m=performance.now();if(m-l<a)return;l=m;const{scale:g,translate:x}=o,[u,f]=T(c,n,o),p=r*g,h=e/p;t.style.left=`${c.clientX}px`,t.style.top=`${c.clientY}px`,s&&(s.clearRect(0,0,e,e),s.save(),s.beginPath(),s.arc(e/2,e/2,e/2,0,Math.PI*2),s.clip(),s.drawImage(n,u-h/2,f-h/2,h,h,0,0,e,e),s.restore())}return{element:t,handleMouse:i}}async function he(n,o,e){for(const r of e)for(const t of[".png",".jpg",".jpeg",".tiff"]){const s=`${n}/${o}${r}${t}`;if(await ve(s))return s}return null}async function Ie(n,o,e){const r=[""],t=["_pol","-pol"],s=await he(o,"TS",r),l=await he(o,"TS",t);if(!s)throw new Error("Aucune image en lumière naturelle trouvée");l||L("Pas d'image en lumière polarisée trouvée");const a=n.querySelector("img.ts-image");if(!a)throw new Error("No .ts-image found for lightModeSwitcher");a.src=s;let i=!1;if(l){const x=new Image;x.src=l,i=!0}function c(){const{scale:x,translate:u}=e,f=`translate(${u.x}px, ${u.y}px) scale(${x})`;imgNat.style.transform=f,imgPol.style.transform=f}e._onChange=()=>c();let m="nat";function g(){m==="nat"&&i?(a.src=l,m="pol",L("Lumière polarisée")):(a.src=s,L("Lumière naturelle"),m="nat"),c()}return{toggle:g}}function Xe(n,o){const{scale:e,translate:r}=o,[t,s]=n.position,l=t*e+r.x,a=s*e+r.y,i=document.createElement("div");return i.className="ts-anno-point",i.style.position="absolute",i.style.width="35px",i.style.height="35px",i.style.borderRadius="50%",i.style.background="#ff0000",i.style.border="2px solid white",i.style.left=`${l}px`,i.style.top=`${a}px`,i.style.cursor="pointer",i.style.pointerEvents="auto",i}function Fe(n){const o=document.createElementNS("http://www.w3.org/2000/svg","polygon");o.setAttribute("fill","rgba(255,0,0,0.2)"),o.setAttribute("stroke","rgba(255,0,0,0.7)"),o.setAttribute("stroke-width","2"),o.setAttribute("pointer-events","auto"),o.style.cursor="pointer";const e=n.points.map(([r,t])=>`${r},${t}`).join(" ");return o.setAttribute("points",e),o}function Ye(n){const{title:o,text:e,image:r}=n.content;return`
        <button class="close-anno">&times;</button>
        ${o?`<h4>${o}</h4>`:""}
        ${e?`<p>${e}</p>`:""}
        ${r?`<img src="${r}" style="max-width:100%;border-radius:6px;" />`:""}
    `}function ge(n,o,e,r,t,s){var $;if(t.has(n.id))return null;const l=document.createElement("div");l.className="ts-popup",l.style.position="absolute",r.appendChild(l);const a=Ye(n);l.innerHTML=a;const[i,c]=o,m=i*e.scale+e.translate.x,g=c*e.scale+e.translate.y;if(l.style.left=`${m}px`,l.style.top=`${g}px`,!s)return console.warn("attach2DPopup : le paramètre 'viewer' est manquant."),l;const x=s.clientWidth,u=s.clientHeight,f=l.offsetWidth,p=l.offsetHeight,h=8;let M=m,d=g;return M+f>x-h&&(M=x-f-h),M<h&&(M=h),d+p>u-h&&(d=u-p-h),d<h&&(d=h),l.style.left=`${M}px`,l.style.top=`${d}px`,t.set(n.id,{popup:l,position:o}),($=l.querySelector(".close-anno"))==null||$.addEventListener("click",()=>{l.remove(),t.delete(n.id)}),l}function le(n,o,e){if(!e)return;const r=e.clientWidth,t=e.clientHeight,s=8;for(const{popup:l,position:a}of n.values()){const[i,c]=a,m=i*o.scale+o.translate.x,g=c*o.scale+o.translate.y,x=l.offsetWidth,u=l.offsetHeight;let f=m;f+x>r-s&&(f=r-x-s),f<s&&(f=s);let p=g;p+u>t-s&&(p=t-u-s),p<s&&(p=s),l.style.left=`${f}px`,l.style.top=`${p}px`}}function He(n){const o=n.length;let e=0,r=0;for(const[t,s]of n)e+=t,r+=s;return[e/o,r/o]}let N=0,q=null,F=null,z=null,re,U,ie,W,R,ae,_,b=null,V=null;function qe(n,o,e,r,t){N=1,b=document.createElementNS("http://www.w3.org/2000/svg","g"),o.appendChild(b),n.style.cursor="crosshair",n.addEventListener("click",s),n.addEventListener("mousemove",l),V=a;function s(i){const c=T(i,r,t);N===1?(q=c,re=K(b,c,t,"blue"),L("Angle : placez le point B pour la normale"),N=2):N===2?(F=c,U=K(b,c,t,"blue"),W=Q(b,q,F,t,"blue"),L("Angle : placez le point C pour mesurer l'angle"),N=3):N===3&&(z=c,ie=K(b,c,t,"red"),R=Q(b,F,z,t,"red"),ae=Ue(b,q,F,z,t,40,"green"),_=Re(F,q,z,t,e,we),N=0)}function l(i){if(N===2){const c=T(i,r,t);W&&b.removeChild(W),U&&b.removeChild(U),W=Q(b,q,c,t,"rgba(0, 0, 255, 0.5)"),U=K(b,c,t,"rgba(0, 0, 255, 0.5)")}if(N===3){const c=T(i,r,t);R&&b.removeChild(R),R=Q(b,F,c,t,"rgba(255, 0, 0, 0.5)")}}function a(){n.style.cursor="",n.removeEventListener("click",s),n.removeEventListener("mousemove",l),b&&b.parentNode&&b.parentNode.removeChild(b),b=null,[re,U,ie].forEach(i=>{i&&i.parentNode&&i.parentNode.removeChild(i)}),[W,R,ae].forEach(i=>{i&&i.parentNode&&i.parentNode.removeChild(i)}),_&&_.parentNode&&_.parentNode.removeChild(_),N=0,q=F=z=null,re=U=ie=null,W=R=ae=null,_=null,V=null}}function K(n,[o,e],r,t){const s=document.createElementNS("http://www.w3.org/2000/svg","circle");return s.setAttribute("cx",o),s.setAttribute("cy",e),s.setAttribute("r","4"),s.setAttribute("fill",t),s.setAttribute("pointer-events","none"),n.appendChild(s),s}function Q(n,o,e,r,t){const[s,l]=o,[a,i]=e,c=document.createElementNS("http://www.w3.org/2000/svg","line");return c.setAttribute("x1",s),c.setAttribute("y1",l),c.setAttribute("x2",a),c.setAttribute("y2",i),c.setAttribute("stroke",t),c.setAttribute("stroke-width","2"),c.setAttribute("pointer-events","none"),n.appendChild(c),c}function Ue(n,o,e,r,t,s=30,l){const a=o[0]-e[0],i=o[1]-e[1],c=r[0]-e[0],m=r[1]-e[1];let g=Math.atan2(i,a),u=Math.atan2(m,c)-g;u>Math.PI?u-=2*Math.PI:u<-Math.PI&&(u+=2*Math.PI);const f=u>0?1:0,p=0,h=s,M=e[0]+Math.cos(g)*h,d=e[1]+Math.sin(g)*h,$=e[0]+Math.cos(g+u)*h,H=e[1]+Math.sin(g+u)*h,I=`M ${M} ${d} A ${h} ${h} 0 ${p} ${f} ${$} ${H}`,D=document.createElementNS("http://www.w3.org/2000/svg","path");return D.setAttribute("d",I),D.setAttribute("fill","none"),D.setAttribute("stroke",l),D.setAttribute("stroke-width","2"),n.appendChild(D),D}function We(n,o){return n[0]*o[0]+n[1]*o[1]}function ye(n){return Math.hypot(n[0],n[1])}function Re(n,o,e,r,t,s){const l=[o[0]-n[0],o[1]-n[1]],a=[e[0]-n[0],e[1]-n[1]],i=Math.acos(We(l,a)/(ye(l)*ye(a)))*180/Math.PI,c=document.createElement("div");c.className="ts-popup",c.innerHTML=`<button class="close-anno">&times;</button><div>${i.toFixed(1)}°</div>`,c.style.position="absolute";const m=n[0]*r.scale+r.translate.x,g=n[1]*r.scale+r.translate.y;return c.style.left=`${m}px`,c.style.top=`${g}px`,t.appendChild(c),c.querySelector(".close-anno").addEventListener("click",()=>{c.remove(),s(),L("Angle : mesure terminée")}),c}function we(){typeof V=="function"&&(V(),V=null)}function _e(n){let o=0;for(let e=0;e<n.length;e++){const[r,t]=n[e],[s,l]=n[(e+1)%n.length];o+=r*l-s*t}return Math.abs(o)/2}let Y,P,B,xe,ce,C=[],Z=[],A=null,k=null,j=null,ee=null;function je(n,o,e,r,t,s=1){Y=t,P=n,B=o,xe=e,ce=s,imgElSM=r,C=[],Z=[],A=document.createElementNS("http://www.w3.org/2000/svg","polygon"),A.setAttribute("fill","rgba(0,150,0,0.3)"),A.setAttribute("stroke","green"),A.setAttribute("stroke-width","2"),A.setAttribute("pointer-events","none"),B.appendChild(A),P.style.cursor="crosshair",P.addEventListener("click",be),P.addEventListener("mousemove",Ee),L("Surface : cliquez pour poser chaque point (≥3 pour terminer)"),ee=Me}function be(n){const[o,e]=T(n,imgElSM,Y);if(C.length>=3){const[t,s]=C[0],l=t-o,a=s-e;if(Math.hypot(l,a)*Y.scale<10){ze();return}}C.push([o,e]);const r=document.createElementNS("http://www.w3.org/2000/svg","circle");r.setAttribute("cx",o),r.setAttribute("cy",e),r.setAttribute("r","4"),r.setAttribute("fill","green"),r.setAttribute("pointer-events","none"),B.appendChild(r),Z.push(r),Oe()}function Ee(n){if(C.length===0)return;k&&B.removeChild(k),P.getBoundingClientRect();const[o,e]=T(n,imgEl,Y),r=C[C.length-1],t=r[0],s=r[1],l=o,a=e,i=document.createElementNS("http://www.w3.org/2000/svg","line");i.setAttribute("x1",t),i.setAttribute("y1",s),i.setAttribute("x2",l),i.setAttribute("y2",a),i.setAttribute("stroke","green"),i.setAttribute("stroke-width","2"),i.setAttribute("pointer-events","none"),B.appendChild(i),k=i}function Oe(){const n=C.map(([o,e])=>`${o},${e}`).join(" ");A.setAttribute("points",n)}function ze(){Me();const o=_e(C)*ce*ce,[e,r]=C.reduce((s,l)=>[s[0]+l[0],s[1]+l[1]],[0,0]).map((s,l)=>s/C.length*Y.scale+(l?Y.translate.y:Y.translate.x)),t=document.createElement("div");t.className="ts-popup",t.style.position="absolute",t.style.left=`${e}px`,t.style.top=`${r}px`,t.innerHTML=`<button class="close-anno">&times;</button><div>${o.toFixed(1)} cm²</div>`,xe.appendChild(t),j=t,t.querySelector(".close-anno").addEventListener("click",()=>Ae()),L(`Surface : ${o.toFixed(1)} cm²`)}function Me(){P.style.cursor="",P.removeEventListener("click",be),P.removeEventListener("mousemove",Ee),Z.forEach(n=>n.parentNode&&n.parentNode.removeChild(n)),Z=[],A&&A.parentNode&&A.parentNode.removeChild(A),A=null,k&&k.parentNode&&k.parentNode.removeChild(k),k=null,j&&j.parentNode&&j.parentNode.removeChild(j),j=null,C=[],ee=null}function Ae(){typeof ee=="function"&&ee()}async function Ge(n){let o=!1,e=[],r=[],t=null,s=null,l=null,a=null,i=!1,c=!1;n.innerHTML="";const m=window.rocheActuelle;if(!m)return;let g=null;for(const v of Pe){const w=`${m.path}TS${v}`;if(await ve(w)){g=w;break}}if(!g){console.warn("Pas de lame mince pour:",m);return}const{viewer:x,panZoomLayer:u,img:f,zoneSvg:p,annotationLayer:h,popupLayer:M}=Ne(n),d={scale:1,translate:{x:0,y:0}};Se([{id:"resetThinView",handler:()=>{d.scale=1,d.translate={x:0,y:0},ue()},toastMsg:"Vue réinitialisée"},{id:"fullscreenThin",handler:()=>{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()},toggleClass:"active"},{id:"toggleAnnotations2D",handler:()=>{H=!H,h.style.display=H?"block":"none",p.style.display=H?"block":"none",le(I,d,f)},toggleClass:"active"},{id:"captureThinScreenshot",handler:async()=>{const v=await $e(x),w=document.createElement("a");w.download=`lame-mince-${Date.now()}.png`,w.href=v,w.click()},toastMsg:"Capture téléchargée"},{id:"toggleMagnifier2D",handler:()=>{if(D=!D,D){n.style.cursor="none";const{element:v,handleMouse:w}=Te(f,d,{size:100,zoomFactor:4});G=v,J=w,document.body.appendChild(G),u.addEventListener("mousemove",J)}else n.style.cursor="default",u.removeEventListener("mousemove",J),J=null,G.remove(),G=null},toggleClass:"active"},{id:"measure2DBtn",handler:()=>{o=!o,o||(pe(p,r,t,s),de(),r=[],t=null,s=null)},toggleClass:"active",toastMsg:"Mesure rectiligne"},{id:"angle2DBtn",handler:()=>{i?(we(),i=!1,L("Angle : annulé")):(qe(u,p,M,x,d),i=!0,L("Angle : placez le point A"))},toggleClass:"active",toastMsg:""},{id:"surface2DBtn",handler:()=>{const v=document.getElementById("surface2DBtn");c?(Ae(),c=!1,v.classList.remove("active"),L("Surface : annulé")):(je(u,p,M,x,d,window.cmPerUnit||1),c=!0,v.classList.add("active"))},toggleClass:"active",toastMsg:"Mesure de surface"},{id:"toggleLightMode2D",handler:()=>{$==null||$.toggle()},toggleClass:"active",toastMsg:""}]),f.src=g;let $;f.onload=async()=>{ue(),te(),window.cmPerUnit=4.5/f.naturalWidth,$||($=await Ie(u,m.path,d))};let H=!0;const I=new Map;let D=!1,G=null,J=null;window.tsTransform=d,ke(u,d,()=>{fe(u,d),te(),le(I,d,f)},{minScale:.2,maxScale:5});function te(){const v=document.querySelector(".scale-bar"),w=document.querySelector(".scale-label"),E=n.querySelector("img.ts-image");if(!v||!w||!E.naturalWidth)return;const S=v.clientWidth/d.scale,X=Le(S,E.naturalWidth,4.5);let O;const oe=X*1e4;oe<=300?O=`${oe.toFixed(1)} µm`:O=`${(oe/1e3).toFixed(2)} mm`,w.textContent=O}function ue(){fe(u,d),window.tsTransform={...d},te(),le(I,d,f)}async function Ce(v){const w=`data/annotations/${v}.json`;let E=[];try{E=await(await fetch(w)).json()}catch{console.warn("Pas d'annotations 2D trouvées")}E.filter(y=>y.viewer==="2D"&&y.type==="point").forEach(y=>{const S=Xe(y,d);S.addEventListener("click",X=>{X.stopPropagation(),ge(y,y.position,d,M,I,f)}),h.appendChild(S)}),E.filter(y=>y.viewer==="2D"&&y.type==="zone").forEach(y=>{const S=Fe(y);S.addEventListener("click",X=>{X.stopPropagation();const O=He(y.points);ge(y,O,d,M,I)}),p.appendChild(S)})}Ce(m.code);function ne(v){if(e.length!==1)return;const[w,E]=T(v,x,d),[y,S]=e[0];l=me(p,[y,S],[w,E],d,l),a?(a.setAttribute("cx",w),a.setAttribute("cy",E)):a=se(p,{x:w,y:E})}function de(){var v;l&&p.removeChild(l),a&&p.removeChild(a),l=null,a=null,pe(p,r,t,s),r=[],t=null,s=null,u.removeEventListener("mousemove",ne),(v=document.getElementById("measure2DBtn"))==null||v.classList.remove("active"),o=!1}u.addEventListener("click",v=>{if(!o)return;const[w,E]=T(v,x,d);if(e.push([w,E]),e.length===1){const y=se(p,{x:w,y:E});r.push(y),u.addEventListener("mousemove",ne);return}else if(e.length===2){u.removeEventListener("mousemove",ne),l&&p.removeChild(l),a&&p.removeChild(a),l=null,a=null;const[y,S]=e[1],X=se(p,{x:y,y:S});r.push(X),t=me(p,e[0],e[1],d,t),s=De(e[0],e[1],d,window.cmPerUnit||1,document.getElementById("popup2DContainer")),e=[],s.querySelector(".close-anno").addEventListener("click",()=>{s.remove(),de()})}})}export{Ge as init2DViewer};
