import{s as D}from"./index-SG_8UmXe.js";function S(s,{width:t="100vw",height:n="100vh"}={}){s.innerHTML="";const l=document.createElement("div");l.classList.add("ts-viewer"),l.style.position="relative",l.style.overflow="hidden",l.style.width=t,l.style.height=n;const o=document.createElement("div");o.classList.add("ts-panzoom"),o.style.position="absolute",o.style.top="0",o.style.left="0",o.style.width="100%",o.style.height="100%",o.style.transformOrigin="0 0",o.style.cursor="grab",o.style.willChange="transform";const e=document.createElement("div");e.classList.add("ts-annotation-layer"),e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.pointerEvents="none",l.appendChild(o),s.appendChild(l);const r=document.createElement("img");r.classList.add("ts-image"),r.style.position="absolute",r.style.top="0",r.style.left="0",r.style.transformOrigin="0 0",r.style.userSelect="none",r.draggable=!1,r.style.willChange="transform",o.appendChild(r);const i=document.createElementNS("http://www.w3.org/2000/svg","svg");i.classList.add("ts-zone-layer"),i.style.position="absolute",i.style.top="0",i.style.left="0",i.style.width="100%",i.style.height="100%",i.style.overflow="visible",i.style.pointerEvents="none",o.appendChild(i),o.appendChild(e);const a=document.createElement("div");return a.classList.add("ts-popup-layer"),a.style.position="absolute",a.style.top="0",a.style.left="0",a.style.width="100%",a.style.height="100%",a.style.pointerEvents="none",l.appendChild(a),{viewer:l,panZoomLayer:o,img:r,zoneSvg:i,annotationLayer:e,popupLayer:a}}function L(s,t){const{scale:n,translate:l}=t;s.style.transform=`translate(${l.x}px, ${l.y}px) scale(${n})`}function M(s,t,n,{minScale:l=.2,maxScale:o=5}={}){let e=!1,r={x:0,y:0};s.addEventListener("wheel",i=>{i.preventDefault();const a=-i.deltaY*.001,c=Math.min(Math.max(l,t.scale+a),o),y=s.getBoundingClientRect(),p=i.clientX-y.left,h=i.clientY-y.top;t.translate.x-=p*(c-t.scale)/t.scale,t.translate.y-=h*(c-t.scale)/t.scale,t.scale=c,n()}),s.addEventListener("mousedown",i=>{e=!0,r.x=i.clientX,r.y=i.clientY,s.style.cursor="grabbing"}),window.addEventListener("mouseup",()=>{e=!1,s.style.cursor="grab"}),window.addEventListener("mousemove",i=>{e&&(t.translate.x+=i.clientX-r.x,t.translate.y+=i.clientY-r.y,r.x=i.clientX,r.y=i.clientY,n())})}const T=[".png",".jpg",".jpeg",".tiff"];async function A(s){try{const t=await fetch(s,{method:"HEAD"}),n=t.headers.get("Content-Type")||"";return t.ok&&n.startsWith("image/")}catch{return!1}}function k(s,t,{size:n=100,zoomFactor:l=4}={}){const o=document.createElement("canvas");o.width=n,o.height=n,o.className="loupe2d",o.style.position="absolute",o.style.pointerEvents="none";let e;try{e=o.getContext("2d")}catch{e=null}let r=0;const i=16;function a(c){const y=performance.now();if(y-r<i)return;r=y;const{scale:p,translate:h}=t,d=s.getBoundingClientRect(),v=(c.clientX-d.left-h.x)/p,x=(c.clientY-d.top-h.y)/p,f=l*p,m=n/f;o.style.left=`${c.clientX}px`,o.style.top=`${c.clientY}px`,e&&(e.clearRect(0,0,n,n),e.save(),e.beginPath(),e.arc(n/2,n/2,n/2,0,Math.PI*2),e.clip(),e.drawImage(s,v-m/2,x-m/2,m,m,0,0,n,n),e.restore())}return{element:o,handleMouse:a}}function P(s,t){const{scale:n,translate:l}=t,[o,e]=s.position,r=o*n+l.x,i=e*n+l.y,a=document.createElement("div");return a.className="ts-anno-point",a.style.position="absolute",a.style.width="10px",a.style.height="10px",a.style.borderRadius="50%",a.style.background="#ff0000",a.style.border="2px solid white",a.style.left=`${r}px`,a.style.top=`${i}px`,a.style.cursor="pointer",a.style.pointerEvents="auto",a}function Y(s){const t=document.createElementNS("http://www.w3.org/2000/svg","polygon");t.setAttribute("fill","rgba(255,0,0,0.2)"),t.setAttribute("stroke","rgba(255,0,0,0.7)"),t.setAttribute("stroke-width","2"),t.setAttribute("pointer-events","auto"),t.style.cursor="pointer";const n=s.points.map(([l,o])=>`${l},${o}`).join(" ");return t.setAttribute("points",n),t}function N(s){const{title:t,text:n,image:l}=s.content;return`
        <button class="close-anno">&times;</button>
        ${t?`<h4>${t}</h4>`:""}
        ${n?`<p>${n}</p>`:""}
        ${l?`<img src="${l}" style="max-width:100%;border-radius:6px;" />`:""}
    `}function $(s,t,n,l,o){var p;if(o.has(s.id))return null;const e=document.createElement("div");e.className="ts-popup",e.style.position="absolute",l.appendChild(e);const r=N(s);e.innerHTML=r;const[i,a]=t,c=i*n.scale+n.translate.x,y=a*n.scale+n.translate.y;return e.style.left=`${c}px`,e.style.top=`${y}px`,o.set(s.id,{popup:e,position:t}),(p=e.querySelector(".close-anno"))==null||p.addEventListener("click",()=>{e.remove(),o.delete(s.id)}),e}function b(s,t){for(const{popup:n,position:l}of s.values()){const[o,e]=l,r=o*t.scale+t.translate.x,i=e*t.scale+t.translate.y,a=n.getBoundingClientRect(),c=10,y=window.innerWidth-a.width-c,p=window.innerHeight-a.height-c;n.style.left=`${Math.max(c,Math.min(r,y))}px`,n.style.top=`${Math.max(c,Math.min(i,p))}px`}}function X(s){const t=s.length;let n=0,l=0;for(const[o,e]of s)n+=o,l+=e;return[n/t,l/t]}async function R(s){s.innerHTML="";const t=window.rocheActuelle;if(!t)return;let n=null;for(const f of T){const m=`${t.path}TS${f}`;if(await A(m)){n=m;break}}if(!n){console.warn("Pas de lame mince pour:",t);return}const{panZoomLayer:l,img:o,zoneSvg:e,annotationLayer:r,popupLayer:i}=S(s);D([{id:"resetThinView",handler:()=>{d.scale=1,d.translate={x:0,y:0},v()},toastMsg:"Vue réinitialisée"},{id:"fullscreenThin",handler:()=>{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()},toggleClass:"active"},{id:"toggleAnnotations2D",handler:()=>{a=!a,r.style.display=a?"block":"none",e.style.display=a?"block":"none",b(c,d)},toggleClass:"active"},{id:"captureThinScreenshot",handler:()=>{const f=s.querySelector(".ts-viewer");html2canvas(f).then(m=>{const g=document.createElement("a");g.download=`lame-mince-${Date.now()}.png`,g.href=m.toDataURL(),g.click()})},toastMsg:"Capture téléchargée"},{id:"toggleMagnifier2D",handler:()=>{if(y=!y,y){s.style.cursor="none";const{element:f,handleMouse:m}=k(o,d,{size:100,zoomFactor:4});p=f,h=m,document.body.appendChild(p),l.addEventListener("mousemove",h)}else s.style.cursor="default",l.removeEventListener("mousemove",h),h=null,p.remove(),p=null},toggleClass:"active"}]),o.src=n,o.onload=()=>v();let a=!0;const c=new Map;let y=!1,p=null,h=null;const d={scale:1,translate:{x:0,y:0}};window.tsTransform=d,M(l,d,()=>{L(l,d),b(c,d)},{minScale:.2,maxScale:5});function v(){L(l,d),window.tsTransform={...d},b(c,d)}async function x(f){const m=`data/annotations/${f}.json`;let g=[];try{g=await(await fetch(m)).json()}catch{console.warn("Pas d'annotations 2D trouvées")}g.filter(u=>u.viewer==="2D"&&u.type==="point").forEach(u=>{const w=P(u,d);w.addEventListener("click",E=>{E.stopPropagation(),$(u,u.position,d,i,c)}),r.appendChild(w)}),g.filter(u=>u.viewer==="2D"&&u.type==="zone").forEach(u=>{const w=Y(u);w.addEventListener("click",E=>{E.stopPropagation();const C=X(u.points);$(u,C,d,i,c)}),e.appendChild(w)})}x(t.code)}export{R as init2DViewer};
